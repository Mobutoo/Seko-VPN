---
# ============================================================
# ci.yml — Pipeline CI/CD Seko-VPN (3 stages)
# Lint → Molecule (14 rôles) → Integration (Hetzner, main only)
# ============================================================
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # ──────────────────────────────────────────────
  # Stage 1 : Lint (yamllint + ansible-lint)
  # ──────────────────────────────────────────────
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r requirements-dev.txt
          ansible-galaxy collection install -r requirements.yml

      - name: Run yamllint
        run: yamllint -c .yamllint .

      - name: Run ansible-lint
        run: ansible-lint

  # ──────────────────────────────────────────────
  # Stage 2 : Molecule (matrice 14 rôles)
  # ──────────────────────────────────────────────
  molecule:
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        role:
          - common
          - security
          - docker
          - hardening
          - caddy
          - headscale
          - headplane
          - vaultwarden
          - portainer
          - zerobyte
          - uptime_kuma
          - monit
          - alloy
          - telegram_bot
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r requirements-dev.txt
          ansible-galaxy collection install -r requirements.yml

      - name: Run Molecule
        working-directory: roles/${{ matrix.role }}
        run: molecule test

  # ──────────────────────────────────────────────
  # Stage 3 : Integration (Hetzner, main seulement)
  # ──────────────────────────────────────────────
  integration:
    needs: molecule
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r requirements-dev.txt hcloud
          ansible-galaxy collection install -r requirements.yml

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keygen -y -f ~/.ssh/id_ed25519 > ~/.ssh/id_ed25519.pub

      - name: Create Hetzner VM
        id: hetzner
        run: |
          pip install hcloud
          python3 -c "
          from hcloud import Client
          from hcloud.images import Image
          from hcloud.server_types import ServerType
          from hcloud.ssh_keys import SSHKey
          import os, time

          client = Client(token=os.environ['HCLOUD_TOKEN'])

          # Ajouter la clé SSH
          with open(os.path.expanduser('~/.ssh/id_ed25519.pub')) as f:
              pubkey = f.read().strip()

          try:
              ssh_key = client.ssh_keys.create(name='ci-key-' + str(int(time.time())), public_key=pubkey)
          except Exception:
              ssh_key = client.ssh_keys.get_by_name('ci-key')

          # Créer le serveur
          server = client.servers.create(
              name='seko-vpn-ci-' + str(int(time.time())),
              server_type=ServerType(name='cx22'),
              image=Image(name='debian-12'),
              ssh_keys=[ssh_key],
              location=client.locations.get_by_name('fsn1')
          )
          server.action.wait_until_finished()

          ip = server.server.public_net.ipv4.ip
          print(f'SERVER_IP={ip}')
          print(f'SERVER_ID={server.server.id}')
          print(f'SSH_KEY_ID={ssh_key.id}')

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'server_ip={ip}\n')
              f.write(f'server_id={server.server.id}\n')
              f.write(f'ssh_key_id={ssh_key.id}\n')
          "

      - name: Wait for SSH
        run: |
          for i in $(seq 1 30); do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@${{ steps.hetzner.outputs.server_ip }} "echo ok" 2>/dev/null; then
              echo "SSH ready"
              break
            fi
            echo "Waiting for SSH... ($i/30)"
            sleep 10
          done

      - name: Create vault password file
        run: |
          echo "${{ secrets.VAULT_PASSWORD }}" > /tmp/.vault_pass
          chmod 600 /tmp/.vault_pass

      - name: Create test inventory
        run: |
          cat > inventory/hosts.yml << EOF
          ---
          all:
            hosts:
              vps:
                ansible_host: ${{ steps.hetzner.outputs.server_ip }}
                ansible_user: root
                ansible_port: 22
                ansible_ssh_private_key_file: ~/.ssh/id_ed25519
          EOF

      - name: Run site.yml with ci_mode
        run: |
          ansible-playbook playbooks/site.yml \
            --extra-vars "ci_mode=true" \
            --extra-vars "@tests/ci-vars.yml" \
            --vault-password-file /tmp/.vault_pass \
            -v

      - name: Cleanup Hetzner
        if: always()
        run: |
          python3 -c "
          from hcloud import Client
          import os

          client = Client(token=os.environ['HCLOUD_TOKEN'])

          server_id = '${{ steps.hetzner.outputs.server_id }}'
          ssh_key_id = '${{ steps.hetzner.outputs.ssh_key_id }}'

          if server_id:
              try:
                  server = client.servers.get_by_id(int(server_id))
                  server.delete()
                  print(f'Server {server_id} deleted')
              except Exception as e:
                  print(f'Error deleting server: {e}')

          if ssh_key_id:
              try:
                  ssh_key = client.ssh_keys.get_by_id(int(ssh_key_id))
                  ssh_key.delete()
                  print(f'SSH key {ssh_key_id} deleted')
              except Exception as e:
                  print(f'Error deleting SSH key: {e}')
          "
