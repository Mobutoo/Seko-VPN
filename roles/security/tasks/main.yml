---
- name: Installer UFW et Fail2Ban
  ansible.builtin.apt:
    name:
      - ufw
      - fail2ban
    state: present

- name: Configurer les règles UFW par défaut
  community.general.ufw:
    state: enabled
    default: deny
    direction: incoming
  when: ansible_virtualization_type != "docker"

- name: Autoriser SSH (port 22 pour le déploiement initial)
  community.general.ufw:
    rule: allow
    port: "22"
    proto: tcp
    comment: "SSH standard"
  when: ansible_virtualization_type != "docker"

- name: Autoriser HTTP
  community.general.ufw:
    rule: allow
    port: "80"
    proto: tcp
    comment: "HTTP"
  when: ansible_virtualization_type != "docker"

- name: Autoriser HTTPS
  community.general.ufw:
    rule: allow
    port: "443"
    proto: tcp
    comment: "HTTPS"
  when: ansible_virtualization_type != "docker"

- name: Autoriser WireGuard (Headscale)
  community.general.ufw:
    rule: allow
    port: "41641"
    proto: udp
    comment: "WireGuard Headscale"
  when: ansible_virtualization_type != "docker"

- name: Autoriser STUN (DERP embarqué Headscale)
  community.general.ufw:
    rule: allow
    port: "3478"
    proto: udp
    comment: "STUN DERP Headscale"
  when: ansible_virtualization_type != "docker"

- name: Autoriser le port SSH custom
  community.general.ufw:
    rule: allow
    port: "{{ ssh_custom_port }}"
    proto: tcp
    comment: "SSH custom"
  when: ansible_virtualization_type != "docker"

- name: Récupérer l'IP du déployeur via SSH_CLIENT
  ansible.builtin.set_fact:
    security_deployer_ip: "{{ ansible_env.SSH_CLIENT.split()[0] }}"
  when:
    - ansible_virtualization_type != "docker"
    - ansible_env.SSH_CLIENT is defined

- name: Configurer Fail2Ban
  ansible.builtin.copy:
    dest: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 5
      backend = systemd

      [sshd]
      enabled = true
      port = ssh,{{ ssh_custom_port }}
      filter = sshd
      maxretry = 3
    mode: "0644"
  notify: Restart fail2ban

- name: Activer Fail2Ban
  ansible.builtin.service:
    name: fail2ban
    state: started
    enabled: true
  when: ansible_virtualization_type != "docker"

- name: "Débannir l'IP du déployeur si bannie"
  ansible.builtin.command:
    cmd: "fail2ban-client set sshd unbanip {{ security_deployer_ip }}"
  register: security_unban_result
  changed_when: "'is not banned' not in security_unban_result.stderr"
  failed_when: false
  when:
    - ansible_virtualization_type != "docker"
    - security_deployer_ip | default('') | length > 0

- name: "Whitelister temporairement l'IP du déployeur (48h)"
  ansible.builtin.copy:
    dest: /etc/fail2ban/jail.d/deployer-whitelist.local
    content: |
      # Whitelist temporaire du deployeur ({{ security_deployer_ip }})
      # Generee par Ansible le {{ ansible_date_time.iso8601 }}
      # Nettoyee automatiquement apres 48h par cron
      [DEFAULT]
      ignoreip = 127.0.0.1/8 ::1 {{ security_deployer_ip }}
    mode: "0644"
  notify: Restart fail2ban
  when:
    - ansible_virtualization_type != "docker"
    - security_deployer_ip | default('') | length > 0

- name: Programmer le nettoyage du whitelist dans 48h
  ansible.builtin.cron:
    name: "fail2ban-remove-deployer-whitelist"
    job: >-
      rm -f /etc/fail2ban/jail.d/deployer-whitelist.local &&
      systemctl reload fail2ban 2>/dev/null;
      crontab -l 2>/dev/null | grep -v fail2ban-remove-deployer-whitelist | crontab -
    minute: "{{ '%M' | strftime(ansible_date_time.epoch | int + 172800) }}"
    hour: "{{ '%H' | strftime(ansible_date_time.epoch | int + 172800) }}"
    day: "{{ '%d' | strftime(ansible_date_time.epoch | int + 172800) }}"
    month: "{{ '%m' | strftime(ansible_date_time.epoch | int + 172800) }}"
  when:
    - ansible_virtualization_type != "docker"
    - security_deployer_ip | default('') | length > 0

- name: Configurer sysctl de sécurité
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_set: true
    reload: true
  loop:
    - { key: "net.ipv4.conf.all.rp_filter", value: "1" }
    - { key: "net.ipv4.conf.default.rp_filter", value: "1" }
    - { key: "net.ipv4.icmp_echo_ignore_broadcasts", value: "1" }
    - { key: "net.ipv4.conf.all.accept_redirects", value: "0" }
    - { key: "net.ipv4.conf.default.accept_redirects", value: "0" }
    - { key: "net.ipv4.conf.all.send_redirects", value: "0" }
    - { key: "net.ipv4.conf.default.send_redirects", value: "0" }
    - { key: "net.ipv4.conf.all.accept_source_route", value: "0" }
    - { key: "net.ipv4.tcp_syncookies", value: "1" }
    - { key: "net.ipv6.conf.all.accept_redirects", value: "0" }
  when: ansible_virtualization_type != "docker"
