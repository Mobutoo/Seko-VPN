---
- name: Installer UFW et Fail2Ban
  ansible.builtin.apt:
    name:
      - ufw
      - fail2ban
    state: present

- name: Configurer les règles UFW par défaut
  community.general.ufw:
    state: enabled
    default: deny
    direction: incoming

- name: Autoriser SSH (port 22 pour le déploiement initial)
  community.general.ufw:
    rule: allow
    port: "22"
    proto: tcp
    comment: "SSH standard"

- name: Autoriser HTTP
  community.general.ufw:
    rule: allow
    port: "80"
    proto: tcp
    comment: "HTTP"

- name: Autoriser HTTPS
  community.general.ufw:
    rule: allow
    port: "443"
    proto: tcp
    comment: "HTTPS"

- name: Autoriser le port SSH custom
  community.general.ufw:
    rule: allow
    port: "{{ ssh_custom_port }}"
    proto: tcp
    comment: "SSH custom"

- name: Configurer Fail2Ban
  ansible.builtin.copy:
    dest: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 5
      backend = systemd

      [sshd]
      enabled = true
      port = ssh,{{ ssh_custom_port }}
      filter = sshd
      maxretry = 3
    mode: "0644"
  notify: Restart fail2ban

- name: Activer Fail2Ban
  ansible.builtin.service:
    name: fail2ban
    state: started
    enabled: true
  when: ansible_virtualization_type != "docker"

- name: Configurer sysctl de sécurité
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_set: true
    reload: true
  loop:
    - { key: "net.ipv4.conf.all.rp_filter", value: "1" }
    - { key: "net.ipv4.conf.default.rp_filter", value: "1" }
    - { key: "net.ipv4.icmp_echo_ignore_broadcasts", value: "1" }
    - { key: "net.ipv4.conf.all.accept_redirects", value: "0" }
    - { key: "net.ipv4.conf.default.accept_redirects", value: "0" }
    - { key: "net.ipv4.conf.all.send_redirects", value: "0" }
    - { key: "net.ipv4.conf.default.send_redirects", value: "0" }
    - { key: "net.ipv4.conf.all.accept_source_route", value: "0" }
    - { key: "net.ipv4.tcp_syncookies", value: "1" }
    - { key: "net.ipv6.conf.all.accept_redirects", value: "0" }
