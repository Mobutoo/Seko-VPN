---
# Docker Compose - Headscale (serveur VPN WireGuard)
# Géré par Ansible - NE PAS MODIFIER MANUELLEMENT

services:
  headscale:
    image: headscale/headscale:{{ headscale_version }}
    container_name: headscale
    restart: unless-stopped
    command: serve
    volumes:
      - ./config:/etc/headscale
      - ./data:/var/lib/headscale
    # Le port STUN (UDP) doit être exposé directement
    # Le trafic HTTPS passe par Caddy
    ports:
      - "3478:3478/udp"    # STUN/DERP relay
    networks:
      - {{ docker_network_name }}
    # Sécurité
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    # Limites de ressources
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

networks:
  {{ docker_network_name }}:
    external: true
