---
# Docker Compose - Headscale {{ headscale_version }}
# Basé sur la documentation officielle
# Géré par Ansible - NE PAS MODIFIER MANUELLEMENT

services:
  headscale:
    image: headscale/headscale:{{ headscale_version }}
    container_name: headscale
    restart: unless-stopped
    command: serve
    # Volume read-only pour la config, read-write pour les données
    volumes:
      - {{ headscale_data_path }}/config:/etc/headscale:ro
      - {{ headscale_data_path }}/data:/var/lib/headscale
    # tmpfs requis par le conteneur distroless
    tmpfs:
      - /var/run/headscale
    # Port STUN (UDP) exposé directement pour le DERP intégré
    # Le trafic HTTPS passe par Caddy
    ports:
      - "3478:3478/udp"
    networks:
      - {{ docker_network_name }}
    # Limites de ressources
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

networks:
  {{ docker_network_name }}:
    external: true
