---
# ============================================================
# Configuration Headscale {{ headscale_version }}
# Basée sur le config-example.yaml officiel v0.26
# Géré par Ansible - NE PAS MODIFIER MANUELLEMENT
# ============================================================

# URL publique du serveur (HTTPS via Caddy)
server_url: https://{{ domain_headscale }}

# Écoute interne (dans le conteneur Docker)
listen_addr: 0.0.0.0:8080

# Métriques (interne)
metrics_listen_addr: 0.0.0.0:9090

# gRPC (pour CLI distante)
grpc_listen_addr: 0.0.0.0:50443
grpc_allow_insecure: true

# --- Noise protocol ---
noise:
  private_key_path: /var/lib/headscale/noise_private.key

# --- Préfixes IP du réseau VPN ---
prefixes:
  v4: {{ headscale_ip_prefixes[0] }}
  v6: {{ headscale_ip_prefixes[1] }}
  allocation: sequential

# --- DERP (relais chiffrés) ---
# CONFIGURÉ POUR SE PASSER DES SERVEURS TAILSCALE INC
derp:
  server:
    # Activer le serveur DERP intégré à Headscale
    enabled: true
    region_id: 999
    region_code: "self"
    region_name: "Self-hosted DERP"
    stun_listen_addr: "0.0.0.0:3478"
    private_key_path: /var/lib/headscale/derp_server_private.key
    automatically_add_embedded_derp_region: true
    # Laisser vide pour auto-détection de l'IP publique
    ipv4: ""
    ipv6: ""

  # PAS de serveurs DERP Tailscale Inc
  urls: []

  # Carte DERP locale (pour ajouter d'autres relais si besoin)
  paths:
    - /etc/headscale/derp-map.yaml

  auto_update_enabled: false
  update_frequency: 24h

# Désactiver la vérification de mises à jour
disable_check_updates: true

# Nœuds éphémères
ephemeral_node_inactivity_timeout: 30m

# --- Base de données ---
database:
  type: sqlite
  debug: false
  gorm:
    prepare_stmt: true
    parameterized_queries: true
    skip_err_record_not_found: true
    slow_threshold: 1000
  sqlite:
    path: /var/lib/headscale/db.sqlite
    write_ahead_log: true
    wal_autocheckpoint: 1000

# --- TLS ---
# Géré par Caddy en amont, pas besoin ici
acme_url: ""
acme_email: ""
tls_letsencrypt_hostname: ""
tls_cert_path: ""
tls_key_path: ""

# --- Logging ---
log:
  format: text
  level: info

# --- Policy / ACL ---
policy:
  mode: file
  path: ""

# --- DNS ---
dns:
  magic_dns: {{ headscale_magic_dns | lower }}
  base_domain: {{ headscale_base_domain }}
  nameservers:
    global:
      - 1.1.1.1
      - 9.9.9.9
