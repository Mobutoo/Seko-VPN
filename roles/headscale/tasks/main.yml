---
# ============================================================
# Rôle : headscale
# Description : Serveur de contrôle VPN WireGuard autohébergé
#   - Alternative self-hosted à Tailscale
#   - Configuré pour fonctionner SANS les serveurs Tailscale Inc
#   - DERP relay intégré
# ============================================================

- name: Création des répertoires Headscale
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - "{{ headscale_data_path }}"
    - "{{ headscale_data_path }}/config"
    - "{{ headscale_data_path }}/data"

- name: Déploiement de la carte DERP personnalisée
  ansible.builtin.template:
    src: derp-map.yaml.j2
    dest: "{{ headscale_data_path }}/config/derp-map.yaml"
    owner: root
    group: root
    mode: "0644"

- name: Déploiement de la configuration Headscale
  ansible.builtin.template:
    src: config.yaml.j2
    dest: "{{ headscale_data_path }}/config/config.yaml"
    owner: root
    group: root
    mode: "0644"

- name: Déploiement du docker-compose Headscale
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ headscale_data_path }}/docker-compose.yml"
    owner: root
    group: root
    mode: "0644"

- name: Arrêt de Headscale si déjà lancé (pour appliquer la config)
  community.docker.docker_compose_v2:
    project_src: "{{ headscale_data_path }}"
    state: absent
  ignore_errors: yes

- name: Démarrage de Headscale
  community.docker.docker_compose_v2:
    project_src: "{{ headscale_data_path }}"
    state: present
    pull: always

# Attente que le service soit prêt
- name: Attente du démarrage de Headscale (15 tentatives)
  ansible.builtin.command: >
    docker exec headscale headscale version
  register: headscale_check
  retries: 15
  delay: 5
  until: headscale_check.rc == 0
  changed_when: false

- name: Affichage de la version Headscale
  ansible.builtin.debug:
    msg: "Headscale démarré : {{ headscale_check.stdout }}"
