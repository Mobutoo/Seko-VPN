# ============================================================
# Configuration SSH durcie - Générée par Ansible
# NE PAS MODIFIER MANUELLEMENT
# ============================================================

# --- Réseau ---
Port {{ ssh_custom_port }}
AddressFamily inet
ListenAddress 0.0.0.0

# --- Authentification ---
# Désactiver complètement l'authentification par mot de passe
PasswordAuthentication no
ChallengeResponseAuthentication no
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys

# Interdire la connexion root
PermitRootLogin no

# Nombre maximum de tentatives par session
MaxAuthTries 3
MaxSessions 3

# Durée maximale pour s'authentifier (en secondes)
LoginGraceTime 30

# --- Sécurité ---
# Désactiver le forwarding X11 et l'agent
X11Forwarding no
AllowAgentForwarding no

# Autoriser le TCP forwarding (nécessaire pour certains tunnels)
AllowTcpForwarding yes

# Désactiver les messages de bienvenue
PrintMotd no
PrintLastLog yes
Banner none

# Vérifier les permissions des fichiers utilisateur
StrictModes yes

# Keepalive pour détecter les connexions mortes
ClientAliveInterval 300
ClientAliveCountMax 2

# Algorithmes cryptographiques forts uniquement
KexAlgorithms sntrup761x25519-sha512@openssh.com,curve25519-sha256,curve25519-sha256@libssh.org
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com
HostKeyAlgorithms ssh-ed25519,rsa-sha2-512,rsa-sha2-256

# --- Restrictions d'accès ---
# Seul l'utilisateur système peut se connecter en SSH
AllowUsers {{ system_user }}

# Désactiver les tunnels et le forwarding inutile
PermitTunnel no
GatewayPorts no

# Journalisation
SyslogFacility AUTH
LogLevel VERBOSE

# Environnement
AcceptEnv LANG LC_*

# Subsystem SFTP
Subsystem sftp /usr/lib/openssh/sftp-server
