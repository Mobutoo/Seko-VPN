---
# ============================================================
# Rôle : common
# Description : Configuration de base du système Debian 13
#   - Ajout des dépôts Debian manquants (contrib, non-free)
#   - Mise à jour des paquets
#   - Création de l'utilisateur système avec sudo
#   - Configuration des locales et du timezone
#
# NOTE : Le durcissement SSH (changement de port, blocage root)
#        est volontairement dans un playbook séparé (harden-ssh.yml)
#        à exécuter EN DERNIER, une fois tout validé.
# ============================================================

# --- Dépôts Debian (install minimale = souvent "main" seul) ---
- name: Configuration des dépôts Debian (main + contrib + non-free-firmware)
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/debian.sources
    content: |
      Types: deb deb-src
      URIs: http://deb.debian.org/debian
      Suites: {{ ansible_distribution_release }} {{ ansible_distribution_release }}-updates
      Components: main contrib non-free-firmware
      Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

      Types: deb deb-src
      URIs: http://deb.debian.org/debian-security
      Suites: {{ ansible_distribution_release }}-security
      Components: main contrib non-free-firmware
      Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg
    owner: root
    group: root
    mode: "0644"
  register: sources_changed

# Supprimer l'ancien sources.list s'il existe (évite les doublons)
- name: Désactivation de l'ancien /etc/apt/sources.list si présent
  ansible.builtin.copy:
    dest: /etc/apt/sources.list
    content: "# Géré par /etc/apt/sources.list.d/debian.sources - Ne pas modifier\n"
    owner: root
    group: root
    mode: "0644"

- name: Mise à jour du cache APT
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: "{{ 0 if sources_changed.changed else 3600 }}"

- name: Mise à jour complète du système
  ansible.builtin.apt:
    upgrade: dist
    autoremove: yes
    autoclean: yes

- name: Installation des paquets de base
  ansible.builtin.apt:
    name:
      - sudo
      - curl
      - wget
      - gnupg
      - ca-certificates
      - apt-transport-https
#      - software-properties-common
      - python3-pip
      - python3-apt               # Requis par certains modules Ansible
      - openssh-server            # S'assurer que SSH est installé
      - unattended-upgrades       # Mises à jour de sécurité automatiques
      - needrestart               # Détecte les services à redémarrer
      - htop
      - tmux
      - jq
      - tree
      - logrotate
      - rsync
      - dnsutils                  # dig, nslookup (utile pour debug DNS)
      - net-tools                 # ifconfig, netstat
      - procps                    # ps, top, free
    state: present

- name: Configuration du timezone
  community.general.timezone:
    name: Europe/Paris

# --- Création de l'utilisateur système ---
- name: "Création de l'utilisateur système : {{ system_user }}"
  ansible.builtin.user:
    name: "{{ system_user }}"
    shell: /bin/bash
    groups:
      - sudo
    append: yes
    create_home: yes
    state: present

- name: "Définition du mot de passe pour {{ system_user }}"
  ansible.builtin.shell: |
    echo '{{ system_user }}:{{ vault_system_user_password }}' | chpasswd
  changed_when: true
  no_log: true

- name: "Création du répertoire .ssh pour {{ system_user }}"
  ansible.builtin.file:
    path: "/home/{{ system_user }}/.ssh"
    state: directory
    owner: "{{ system_user }}"
    group: "{{ system_user }}"
    mode: "0700"

- name: "Ajout de la clé SSH pour {{ system_user }}"
  ansible.posix.authorized_key:
    user: "{{ system_user }}"
    key: "{{ system_user_ssh_pubkey }}"
    state: present
    exclusive: yes

- name: "Droit sudo sans mot de passe pour {{ system_user }}"
  ansible.builtin.copy:
    dest: "/etc/sudoers.d/{{ system_user }}"
    content: "{{ system_user }} ALL=(ALL) NOPASSWD:ALL\n"
    owner: root
    group: root
    mode: "0440"
    validate: "visudo -cf %s"

# --- Mises à jour automatiques de sécurité ---
- name: Activation des mises à jour automatiques de sécurité
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
      APT::Periodic::AutocleanInterval "7";
    owner: root
    group: root
    mode: "0644"

- name: Configuration d'unattended-upgrades (sécurité uniquement)
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    content: |
      Unattended-Upgrade::Allowed-Origins {
          "${distro_id}:${distro_codename}-security";
      };
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "false";
    owner: root
    group: root
    mode: "0644"

# --- Vérification que l'utilisateur peut se connecter ---
- name: "Vérification : {{ system_user }} peut exécuter sudo"
  ansible.builtin.command: "su - {{ system_user }} -c 'sudo whoami'"
  changed_when: false
  register: sudo_check
  failed_when: sudo_check.stdout != "root"

- name: "Utilisateur {{ system_user }} prêt"
  ansible.builtin.debug:
    msg: >
      L'utilisateur '{{ system_user }}' est créé avec accès sudo.
      Vous pouvez vous connecter avec : ssh {{ system_user }}@{{ server_ip }}
