# ============================================================
# Monit - Supervision système
# Géré par Ansible - NE PAS MODIFIER MANUELLEMENT
# ============================================================
# Les alertes Telegram sont déclenchées via exec dans chaque check.
# Monit passe automatiquement les variables $MONIT_SERVICE,
# $MONIT_EVENT et $MONIT_DESCRIPTION au script.

# --- CPU ---
check system $HOST
  if loadavg (1min) per core > 2 for 5 cycles then exec "/etc/monit/scripts/telegram-alert.sh"
  if loadavg (5min) per core > 1.5 for 10 cycles then exec "/etc/monit/scripts/telegram-alert.sh"
  if cpu usage > {{ monit_cpu_threshold }}% for 10 cycles then exec "/etc/monit/scripts/telegram-alert.sh"

# --- RAM ---
  if memory usage > {{ monit_mem_threshold }}% for 5 cycles then exec "/etc/monit/scripts/telegram-alert.sh"

# --- Swap ---
  if swap usage > {{ monit_swap_threshold }}% for 5 cycles then exec "/etc/monit/scripts/telegram-alert.sh"

# --- Espace disque racine ---
check filesystem rootfs with path /
  if space usage > {{ monit_disk_threshold }}% then exec "/etc/monit/scripts/telegram-alert.sh"
  if inode usage > 90% then exec "/etc/monit/scripts/telegram-alert.sh"

# --- Espace disque /opt/services (données applicatives) ---
check filesystem datafs with path {{ base_deploy_path }}
  if space usage > {{ monit_disk_threshold }}% then exec "/etc/monit/scripts/telegram-alert.sh"
  if inode usage > 90% then exec "/etc/monit/scripts/telegram-alert.sh"
