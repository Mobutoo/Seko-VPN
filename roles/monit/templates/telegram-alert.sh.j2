#!/bin/bash
# ============================================================
# Script d'alerte Telegram pour Monit
# GÃ©rÃ© par Ansible - NE PAS MODIFIER MANUELLEMENT
# ============================================================

BOT_TOKEN="{{ vault_telegram_bot_token }}"
CHAT_ID="{{ vault_telegram_chat_id }}"
HOSTNAME="$(hostname)"

# Message passÃ© en argument ou via les variables Monit
if [ -n "$1" ]; then
  MESSAGE="$1"
else
  # Variables d'environnement Monit
  MESSAGE="ğŸ”” <b>Alerte Monit</b>
ğŸ–¥ï¸ <b>Serveur :</b> ${HOSTNAME}
ğŸ“‹ <b>Service :</b> ${MONIT_SERVICE:-inconnu}
ğŸ“Š <b>Ã‰vÃ©nement :</b> ${MONIT_EVENT:-inconnu}
ğŸ“ <b>Description :</b> ${MONIT_DESCRIPTION:-aucune}
ğŸ• <b>Date :</b> $(date '+%Y-%m-%d %H:%M:%S')"
fi

# Envoi via API Telegram Bot
/usr/bin/curl -s -X POST \
  "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
  -d "chat_id=${CHAT_ID}" \
  -d "parse_mode=HTML" \
  -d "text=${MESSAGE}" \
  -d "disable_web_page_preview=true" \
  > /dev/null 2>&1

exit 0
