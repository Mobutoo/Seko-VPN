---
# Docker Compose - Headplane + Headscale (Web UI intégrée)
# Géré par Ansible - NE PAS MODIFIER MANUELLEMENT
#
# Headplane et Headscale DOIVENT être dans le même compose project
# pour que l'intégration Docker (label + socket) fonctionne.

services:
  headplane:
    image: ghcr.io/tale/headplane:{{ headplane_version }}
    container_name: headplane
    restart: unless-stopped
    depends_on:
      headscale:
        condition: service_started
    volumes:
      # Config Headplane
      - {{ headplane_data_path }}/config.yaml:/etc/headplane/config.yaml:ro
      # Données persistantes Headplane (DB, cache)
      - {{ headplane_data_path }}/data:/var/lib/headplane
      # Config Headscale partagée (RW pour modifier DNS/settings depuis l'UI)
      - {{ headscale_data_path }}/config/config.yaml:/etc/headscale/config.yaml
      # Socket Docker (pour détecter et redémarrer Headscale)
      - /var/run/docker.sock:/var/run/docker.sock:ro
    expose:
      - "3000"
    networks:
      - {{ docker_network_name }}
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

  headscale:
    image: headscale/headscale:{{ headscale_version }}
    container_name: headscale
    restart: unless-stopped
    command: serve
    labels:
      # Label OBLIGATOIRE pour que Headplane trouve Headscale via Docker API
      me.tale.headplane.target: "headscale"
    volumes:
      - {{ headscale_data_path }}/config:/etc/headscale:ro
      - {{ headscale_data_path }}/data:/var/lib/headscale
    tmpfs:
      - /var/run/headscale
    ports:
      - "3478:3478/udp"
    networks:
      - {{ docker_network_name }}
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

networks:
  {{ docker_network_name }}:
    external: true
