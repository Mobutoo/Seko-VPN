---
- name: Installer Python3 et venv
  ansible.builtin.apt:
    name:
      - python3
      - python3-pip
      - python3-venv
    state: present

- name: Créer le répertoire du bot
  ansible.builtin.file:
    path: "{{ telegram_bot_path }}"
    state: directory
    mode: "0755"

- name: Créer le répertoire de logs
  ansible.builtin.file:
    path: /var/log/telegram-bot
    state: directory
    mode: "0755"

- name: Déployer le script bot.py
  ansible.builtin.template:
    src: bot.py.j2
    dest: "{{ telegram_bot_path }}/bot.py"
    mode: "0755"
  notify: Restart telegram-bot

- name: Déployer le fichier .env
  ansible.builtin.template:
    src: .env.j2
    dest: "{{ telegram_bot_path }}/.env"
    mode: "0600"
    owner: root
    group: root
  notify: Restart telegram-bot

- name: Déployer requirements.txt
  ansible.builtin.template:
    src: requirements.txt.j2
    dest: "{{ telegram_bot_path }}/requirements.txt"
    mode: "0644"

- name: Créer le virtualenv Python
  ansible.builtin.command:
    cmd: python3 -m venv "{{ telegram_bot_path }}/venv"
    creates: "{{ telegram_bot_path }}/venv/bin/python"

- name: Installer les dépendances Python
  ansible.builtin.command:
    cmd: "{{ telegram_bot_path }}/venv/bin/pip install -r {{ telegram_bot_path }}/requirements.txt"
  register: telegram_bot_pip_install
  changed_when: "'Successfully installed' in telegram_bot_pip_install.stdout"

- name: Déployer le service systemd
  ansible.builtin.template:
    src: telegram-bot.service.j2
    dest: /etc/systemd/system/telegram-bot.service
    mode: "0644"
  notify: Restart telegram-bot

- name: Recharger systemd
  ansible.builtin.systemd:
    daemon_reload: true

- name: Activer et démarrer le bot Telegram
  ansible.builtin.service:
    name: telegram-bot
    state: started
    enabled: true
