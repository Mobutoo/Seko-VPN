---
# Docker Compose - Vaultwarden (gestionnaire de mots de passe)
# Géré par Ansible - NE PAS MODIFIER MANUELLEMENT

services:
  vaultwarden:
    image: vaultwarden/server:{{ vaultwarden_version }}
    container_name: vaultwarden
    restart: unless-stopped
    environment:
      # --- Domaine ---
      DOMAIN: "https://{{ domain_vaultwarden }}"

      # --- Interface admin ---
      ADMIN_TOKEN: "{{ vault_vaultwarden_admin_token }}"

      # --- Inscriptions ---
      SIGNUPS_ALLOWED: "{{ vaultwarden_signups_allowed | lower }}"

      # --- Sécurité ---
      INVITATIONS_ALLOWED: "false"
      ROCKET_WORKERS: "{{ vaultwarden_rocket_workers }}"
      ROCKET_ADDRESS: "0.0.0.0"
      ROCKET_PORT: "80"

      # --- WebSocket ---
      WEBSOCKET_ENABLED: "true"
      WEBSOCKET_PORT: "3012"

      # --- Logging vers stdout (pas de fichier) ---
      LOG_LEVEL: "info"
      EXTENDED_LOGGING: "true"

      # --- Divers ---
      SHOW_PASSWORD_HINT: "false"
      SENDS_ALLOWED: "true"
      EMERGENCY_ACCESS_ALLOWED: "true"
      ORG_CREATION_USERS: "all"

    volumes:
      - {{ vaultwarden_data_path }}/data:/data
    expose:
      - "80"
      - "3012"
    ports:
      - "127.0.0.1:8280:80"
    networks:
      - {{ docker_network_name }}
    # Limites de ressources
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

networks:
  {{ docker_network_name }}:
    external: true
