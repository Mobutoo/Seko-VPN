// config.alloy — Géré par Ansible
// Collecteur de logs/métriques Grafana Alloy

{% if alloy_collect_docker | default(true) | bool %}
// --- Source : logs Docker natifs via socket ---
discovery.docker "containers" {
    host = "unix://{{ alloy_docker_socket_path }}"
}

discovery.relabel "docker_logs" {
    targets = discovery.docker.containers.targets
    rule {
        source_labels = ["__meta_docker_container_name"]
        regex         = "/(.*)"
        target_label  = "container"
    }
}

loki.source.docker "containers" {
    host       = "unix://{{ alloy_docker_socket_path }}"
    targets    = discovery.relabel.docker_logs.output
    forward_to = [loki.process.default.receiver]
}
{% endif %}

// --- Source : logs fichiers ---
local.file_match "system_logs" {
    path_targets = [
        {__path__ = "/var/log/*.log"},
    ]
}

loki.source.file "system" {
    targets    = local.file_match.system_logs.targets
    forward_to = [loki.process.default.receiver]
}

// --- Source : journal systemd ---
loki.source.journal "systemd" {
    forward_to = [loki.process.default.receiver]
    labels     = {
        job = "systemd-journal",
    }
}

// --- Processing ---
loki.process "default" {
    stage.static_labels {
        values = {
            hostname = "{{ alloy_hostname | default('seko-vpn') }}",
        }
    }
{% if alloy_loki_url | default('') | length > 0 %}
    forward_to = [loki.write.default.receiver]
{% else %}
    // Loki désactivé — les logs sont collectés mais pas envoyés
    // Pour activer : définir alloy_loki_url dans vars.yml
    forward_to = []
{% endif %}
}

{% if alloy_loki_url | default('') | length > 0 %}
// --- Destination : Loki ---
loki.write "default" {
    endpoint {
        url = "{{ alloy_loki_url }}"
    }
}
{% else %}
// --- Loki désactivé ---
// À activer après exposition de Loki via VPN sur VPAI :
// alloy_loki_url: "http://<vpai_tailscale_ip>:3100/loki/api/v1/push"
{% endif %}
