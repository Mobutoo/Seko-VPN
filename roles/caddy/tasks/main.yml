---
- name: Créer les répertoires Caddy
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ caddy_data_path }}"
    - "{{ caddy_data_path }}/conf"
    - "{{ caddy_data_path }}/files"

- name: Déployer le Caddyfile
  ansible.builtin.template:
    src: Caddyfile.j2
    dest: "{{ caddy_data_path }}/conf/Caddyfile"
    mode: "0644"
  notify: Restart caddy

- name: Copier la page 403 VPN-only
  ansible.builtin.copy:
    src: restricted-zone.html
    dest: "{{ caddy_data_path }}/files/restricted-zone.html"
    mode: "0644"
  notify: Restart caddy

- name: Déployer le docker-compose Caddy
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ caddy_data_path }}/docker-compose.yml"
    mode: "0644"

- name: Démarrer Caddy
  community.docker.docker_compose_v2:
    project_src: "{{ caddy_data_path }}"
    state: present
