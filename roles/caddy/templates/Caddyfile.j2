# ============================================================
# Caddyfile - Reverse Proxy avec SSL automatique
# Géré par Ansible - NE PAS MODIFIER MANUELLEMENT
# ============================================================

# Configuration globale
{
	# Email pour les certificats Let's Encrypt
	email {{ acme_email }}

	# Options de sécurité
	servers {
		protocols h1 h2 h3
	}
}

# --- Headscale (API + clients WireGuard) ---
{{ domain_headscale }} {
	reverse_proxy headscale:8080 {
		# Nécessaire pour les connexions WireGuard/Noise
		flush_interval -1
	}

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		Referrer-Policy "strict-origin-when-cross-origin"
		-Server
	}

	log {
		output file /data/logs/headscale.log {
			roll_size 10mb
			roll_keep 5
		}
	}
}

# --- Headplane (UI de gestion Headscale) ---
{{ domain_headplane }} {
	reverse_proxy headplane:3000 {
		flush_interval -1
	}

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
		-Server
	}

	log {
		output file /data/logs/headplane.log {
			roll_size 10mb
			roll_keep 5
		}
	}
}

# --- Vaultwarden ---
{{ domain_vaultwarden }} {
	reverse_proxy vaultwarden:80

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		Content-Security-Policy "default-src 'self'; script-src 'self' 'wasm-unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' wss:;"
		-Server
	}

	log {
		output file /data/logs/vaultwarden.log {
			roll_size 10mb
			roll_keep 5
		}
	}
}

# --- Portainer ---
{{ domain_portainer }} {
	reverse_proxy portainer:9000

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
		-Server
	}

	log {
		output file /data/logs/portainer.log {
			roll_size 10mb
			roll_keep 5
		}
	}
}

# --- Zerobyte (Gestion des sauvegardes) ---
{{ domain_zerobyte }} {
	reverse_proxy zerobyte:4096

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
		-Server
	}

	log {
		output file /data/logs/zerobyte.log {
			roll_size 10mb
			roll_keep 5
		}
	}
}

# --- Monit (Supervision et alerting) ---
# Monit tourne sur le host (apt), pas dans Docker.
# On passe par l'IP passerelle du réseau bridge Docker (172.17.0.1)
# pour atteindre localhost:2812 du host depuis le conteneur Caddy.
{{ domain_monit }} {
	reverse_proxy 172.17.0.1:{{ monit_web_port }}

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
		-Server
	}

	log {
		output file /data/logs/monit.log {
			roll_size 10mb
			roll_keep 5
		}
	}
}
