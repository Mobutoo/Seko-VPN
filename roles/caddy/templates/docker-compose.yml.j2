---
# Docker Compose - Caddy Reverse Proxy
# Géré par Ansible - NE PAS MODIFIER MANUELLEMENT

services:
  caddy:
    image: caddy:2-alpine
    container_name: caddy
    restart: unless-stopped
    ports:
      # Ports exposés publiquement
      - "80:80"       # HTTP (redirection automatique vers HTTPS)
      - "443:443"     # HTTPS
      - "443:443/udp" # HTTP/3 (QUIC)
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./data:/data          # Certificats SSL et état Caddy
      - ./config:/config      # Configuration auto-générée
    networks:
      - {{ docker_network_name }}
    # Limites de ressources
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    # Sécurité : capabilities minimales
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE    # Nécessaire pour les ports 80/443
    security_opt:
      - no-new-privileges:true

networks:
  {{ docker_network_name }}:
    external: true
