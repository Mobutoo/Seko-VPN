---
# ============================================================
# Playbook de vérification post-déploiement
# ============================================================
# Usage :
#   ansible-playbook playbooks/verify.yml -e "ansible_port={{ ssh_custom_port }}" -e "ansible_user={{ system_user }}"
#
# Ce playbook vérifie que tous les services sont opérationnels
# et que la sécurité est correctement configurée.
# ============================================================

- name: "Vérification post-déploiement"
  hosts: all
  become: true
  gather_facts: true

  tasks:
    # ===== SERVICES DOCKER =====
    - name: "CHECK : Docker daemon en fonctionnement"
      ansible.builtin.command: docker info
      changed_when: false
      register: docker_check
      failed_when: docker_check.rc != 0

    - name: "CHECK : Conteneurs en cours d'exécution"
      ansible.builtin.command: docker ps --format "{{ '{{' }}.Names{{ '}}' }} - {{ '{{' }}.Status{{ '}}' }}"
      changed_when: false
      register: docker_ps

    - name: Affichage des conteneurs
      ansible.builtin.debug:
        msg: "{{ docker_ps.stdout_lines }}"

    - name: "CHECK : Conteneur Caddy en cours d'exécution"
      ansible.builtin.command: docker inspect -f "{{ '{{' }}.State.Running{{ '}}' }}" caddy
      changed_when: false
      register: caddy_status
      failed_when: caddy_status.stdout != "true"

    - name: "CHECK : Conteneur Headscale en cours d'exécution"
      ansible.builtin.command: docker inspect -f "{{ '{{' }}.State.Running{{ '}}' }}" headscale
      changed_when: false
      register: headscale_status
      failed_when: headscale_status.stdout != "true"

    - name: "CHECK : Conteneur Vaultwarden en cours d'exécution"
      ansible.builtin.command: docker inspect -f "{{ '{{' }}.State.Running{{ '}}' }}" vaultwarden
      changed_when: false
      register: vaultwarden_status
      failed_when: vaultwarden_status.stdout != "true"

    - name: "CHECK : Conteneur Portainer en cours d'exécution"
      ansible.builtin.command: docker inspect -f "{{ '{{' }}.State.Running{{ '}}' }}" portainer
      changed_when: false
      register: portainer_status
      failed_when: portainer_status.stdout != "true"

    # ===== HEALTHCHECKS =====
    - name: "CHECK : Vaultwarden répond"
      ansible.builtin.uri:
        url: "http://localhost:8280/alive"
        method: GET
        status_code: 200
      register: vw_alive

    - name: "CHECK : Headscale répond"
      ansible.builtin.command: docker exec headscale headscale version
      changed_when: false
      register: hs_version

    # ===== SÉCURITÉ : FIREWALL =====
    - name: "CHECK : UFW est actif"
      ansible.builtin.command: ufw status verbose
      changed_when: false
      register: ufw_status

    - name: Affichage du statut UFW
      ansible.builtin.debug:
        msg: "{{ ufw_status.stdout_lines }}"

    # ===== SÉCURITÉ : FAIL2BAN =====
    - name: "CHECK : Fail2Ban est actif"
      ansible.builtin.command: fail2ban-client status
      changed_when: false
      register: f2b_status

    - name: Affichage du statut Fail2Ban
      ansible.builtin.debug:
        msg: "{{ f2b_status.stdout_lines }}"

    # ===== SÉCURITÉ : SSH =====
    - name: "CHECK : SSH n'écoute pas sur le port 22"
      ansible.builtin.wait_for:
        port: 22
        state: stopped
        timeout: 5
      ignore_errors: yes
      register: port22_check

    - name: "CHECK : SSH écoute sur le port {{ ssh_custom_port }}"
      ansible.builtin.wait_for:
        port: "{{ ssh_custom_port }}"
        state: started
        timeout: 5

    - name: "CHECK : Connexion root SSH désactivée"
      ansible.builtin.command: grep "^PermitRootLogin" /etc/ssh/sshd_config
      changed_when: false
      register: ssh_root
      failed_when: "'no' not in ssh_root.stdout"

    - name: "CHECK : Authentification par mot de passe désactivée"
      ansible.builtin.command: grep "^PasswordAuthentication" /etc/ssh/sshd_config
      changed_when: false
      register: ssh_passwd
      failed_when: "'no' not in ssh_passwd.stdout"

    # ===== SÉCURITÉ : PORTS OUVERTS =====
    - name: "CHECK : Scan des ports en écoute"
      ansible.builtin.command: ss -tlnp
      changed_when: false
      register: open_ports

    - name: Affichage des ports en écoute
      ansible.builtin.debug:
        msg: "{{ open_ports.stdout_lines }}"

    # ===== SÉCURITÉ : PERMISSIONS =====
    - name: "CHECK : Permissions sur /etc/shadow"
      ansible.builtin.stat:
        path: /etc/shadow
      register: shadow_perms

    - name: "VERIFY : /etc/shadow en 0600"
      ansible.builtin.assert:
        that: shadow_perms.stat.mode == "0600"
        fail_msg: "/etc/shadow a des permissions trop larges : {{ shadow_perms.stat.mode }}"

    # ===== RÉSEAU DOCKER =====
    - name: "CHECK : Réseau proxy-net existe"
      ansible.builtin.command: docker network inspect {{ docker_network_name }}
      changed_when: false
      register: docker_net
      failed_when: docker_net.rc != 0

    # ===== RÉSUMÉ =====
    - name: Résumé des vérifications
      ansible.builtin.debug:
        msg: |
          ╔══════════════════════════════════════════╗
          ║     RÉSULTAT DES VÉRIFICATIONS           ║
          ╠══════════════════════════════════════════╣
          ║ Docker       : ✓ OK                      ║
          ║ Caddy        : ✓ {{ caddy_status.stdout }}
          ║ Headscale    : ✓ {{ hs_version.stdout | trim }}
          ║ Vaultwarden  : ✓ HTTP {{ vw_alive.status }}
          ║ Portainer    : ✓ {{ portainer_status.stdout }}
          ║ UFW          : ✓ Actif                   ║
          ║ Fail2Ban     : ✓ Actif                   ║
          ║ SSH durci    : ✓ Port {{ ssh_custom_port }}
          ║ Root SSH     : ✓ Désactivé               ║
          ╚══════════════════════════════════════════╝
