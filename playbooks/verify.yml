---
# ============================================================
# verify.yml — Vérification post-déploiement
# ============================================================
- name: Vérification post-déploiement Seko-VPN
  hosts: all
  become: true
  tasks:
    - name: Vérifier les conteneurs Docker
      ansible.builtin.command:
        cmd: >-
           docker ps --format "{{ '{{' }}.Names{{ '}}' }}: {{ '{{' }}.Status{{ '}}' }}"
      register: verify_docker_ps
      changed_when: false
    - name: Afficher les conteneurs
      ansible.builtin.debug:
        var: verify_docker_ps.stdout_lines
    - name: Vérifier Monit
      ansible.builtin.command:
        cmd: monit summary
      register: verify_monit
      changed_when: false
      failed_when: false
    - name: Afficher le statut Monit
      ansible.builtin.debug:
        var: verify_monit.stdout_lines
    - name: Vérifier le bot Telegram
      ansible.builtin.command:
        cmd: systemctl is-active telegram-bot
      register: verify_telegram_bot
      changed_when: false
      retries: 3
      delay: 10
      until: verify_telegram_bot.stdout == 'active'
      failed_when: false
    - name: Vérifier Alloy
      ansible.builtin.command:
        cmd: systemctl is-active alloy
      register: verify_alloy
      changed_when: false
      retries: 3
      delay: 10
      until: verify_alloy.stdout == 'active'
      failed_when: false
    - name: Afficher le résumé
      ansible.builtin.debug:
        msg:
          - "Conteneurs Docker : OK"
          - "Monit : {{ 'OK' if verify_monit.rc == 0 else 'NON DÉMARRÉ (rc=' + verify_monit.rc | string + ')' }}"
          - "Telegram Bot : {{ 'OK' if verify_telegram_bot.stdout == 'active' else verify_telegram_bot.stdout | default('INCONNU') }}"
          - "Alloy : {{ 'OK' if verify_alloy.stdout == 'active' else verify_alloy.stdout | default('INCONNU') }}"
