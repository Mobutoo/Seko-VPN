---
# playbooks/vpn-toggle.yml — Bascule VPN-Only Seko-VPN
#
# Usage:
#   ansible-playbook playbooks/vpn-toggle.yml -e "vpn_mode=on" --ask-vault-pass
#   ansible-playbook playbooks/vpn-toggle.yml -e "vpn_mode=off" --ask-vault-pass
#
# Make shortcuts:
#   make vpn-on    → bascule mode VPN-only
#   make vpn-off   → retour mode public
#
# Architecture :
#   UFW : IDENTIQUE dans les deux modes — 80+443 toujours ouverts à tous.
#         Raison : les clients Tailscale doivent joindre Headscale (singa:443)
#         AVANT d'avoir une IP VPN — restriction UFW = bootstrap impossible.
#   CADDY : gère la protection VPN-only via le snippet (vpn_only) dans le Caddyfile.
#           caddy_vpn_enforce=true  → @blocked not client_ip 100.64.0.0/10 → error 403
#           caddy_vpn_enforce=false → snippet vide → accès public
#   Headscale (singa) + Uptime Kuma (misu) : toujours publics (pas de vpn_only)
#
# Sécurité : dead man switch via `at` — si le toggle Caddy échoue,
# l'ancien Caddyfile est restauré après 15 minutes.

# ============================================================
# PLAY 1 : Validation du paramètre vpn_mode
# ============================================================
- name: "VPN Toggle — Validate input"
  hosts: localhost
  gather_facts: false
  become: false
  tasks:
    - name: "Vérifier le paramètre vpn_mode"
      ansible.builtin.assert:
        that:
          - vpn_mode is defined
          - vpn_mode in ['on', 'off']
        fail_msg: >
          Variable vpn_mode requise (on|off).
          Usage: ansible-playbook playbooks/vpn-toggle.yml -e "vpn_mode=on"

    - name: "Afficher la direction du toggle"
      ansible.builtin.debug:
        msg:
          - "══════════════════════════════════════════"
          - "  VPN TOGGLE → {{ 'VPN-ONLY' if vpn_mode == 'on' else 'PUBLIC' }}"
          - "══════════════════════════════════════════"

# ============================================================
# PLAY 2 : Pre-flight checks
# ============================================================
- name: "VPN Toggle — Pre-flight checks"
  hosts: all
  gather_facts: true
  tasks:
    - name: "PRE-FLIGHT 1/4: Vérifier la connexion SSH"
      ansible.builtin.ping:

    - name: "PRE-FLIGHT 2/4: Valider la config sshd"
      ansible.builtin.command:
        cmd: sshd -t
      changed_when: false

    - name: "PRE-FLIGHT 3/4: Vérifier le port SSH dans UFW"
      ansible.builtin.command:
        cmd: ufw status
      changed_when: false
      register: _ufw_status

    - name: "PRE-FLIGHT 3/4: Confirmer le port SSH autorisé"
      ansible.builtin.assert:
        that:
          - "_ufw_status.stdout is search(ssh_custom_port | string)"
        fail_msg: "ARRÊT : port SSH {{ ssh_custom_port }} absent des règles UFW !"

    - name: "PRE-FLIGHT 4/4: Vérifier les conteneurs critiques"
      ansible.builtin.command:
        cmd: docker ps --format "{{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}"
      changed_when: false
      register: _containers

    - name: "PRE-FLIGHT: Afficher les conteneurs"
      ansible.builtin.debug:
        msg: "{{ _containers.stdout_lines }}"

# ============================================================
# PLAY 3 : Toggle (dead man switch + UFW + Caddy)
# ============================================================
- name: "VPN Toggle — Apply changes"
  hosts: all
  gather_facts: false
  vars_files:
    - "{{ playbook_dir }}/../roles/caddy/defaults/main.yml"
  tasks:
    # --- DEAD MAN SWITCH ---
    # Sauvegarde le Caddyfile actuel et programme sa restauration dans 15 min
    # si le toggle échoue (Caddy planté, connexion coupée, etc.)
    - name: "SÉCURITÉ: Sauvegarder le Caddyfile actuel"
      ansible.builtin.shell:
        executable: /bin/bash
        cmd: cp "{{ caddy_data_path }}/conf/Caddyfile" /tmp/Caddyfile.vpn-toggle-backup
      changed_when: true

    - name: "SÉCURITÉ: Armer le dead man switch (restaure Caddyfile dans 15 min)"
      ansible.builtin.shell:
        executable: /bin/bash
        cmd: |
          set -euo pipefail
          OUTPUT=$(echo "cp /tmp/Caddyfile.vpn-toggle-backup {{ caddy_data_path }}/conf/Caddyfile && \
                docker exec caddy caddy reload --config /etc/caddy/Caddyfile 2>/dev/null || \
                docker restart caddy" | at now + 15 minutes 2>&1)
          echo "$OUTPUT"
          echo "$OUTPUT" | grep -oP 'job\s+\K\d+'
      register: _dms_output
      changed_when: true

    # --- CADDY TOGGLE ---
    # UFW : identique dans les deux modes (80+443 toujours ouverts à tous)
    # La protection VPN-only est assurée par Caddy via le snippet (vpn_only)
    - name: "CADDY: Redéployer le Caddyfile"
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../roles/caddy/templates/Caddyfile.j2"
        dest: "{{ caddy_data_path }}/conf/Caddyfile"
        mode: "0644"
      vars:
        caddy_vpn_enforce: "{{ vpn_mode == 'on' }}"
      notify: Restart caddy after toggle

    - name: "CADDY: Flush handler pour redémarrer maintenant"
      ansible.builtin.meta: flush_handlers

    - name: "CADDY: Attendre que Caddy soit healthy"
      ansible.builtin.shell:
        executable: /bin/bash
        cmd: |
          set -euo pipefail
          for i in $(seq 1 12); do
            if docker exec caddy caddy version > /dev/null 2>&1; then
              echo "healthy"
              exit 0
            fi
            sleep 5
          done
          echo "timeout"
          exit 1
      changed_when: false

    # --- ANNULER DEAD MAN SWITCH ---
    - name: "SÉCURITÉ: Annuler le dead man switch (toggle réussi)"
      ansible.builtin.shell:
        executable: /bin/bash
        cmd: |
          set -euo pipefail
          JOB_ID=$(echo "{{ _dms_output.stdout_lines | last }}" | grep -oP '^\d+$' || true)
          if [[ -n "$JOB_ID" ]]; then
            atrm "$JOB_ID" 2>/dev/null || true
            echo "removed job $JOB_ID"
          else
            echo "no job id found, skipping"
          fi
      changed_when: true

  handlers:
    - name: Restart caddy after toggle
      community.docker.docker_compose_v2:
        project_src: "{{ caddy_data_path }}"
        state: restarted
        services:
          - caddy

# ============================================================
# PLAY 4 : Post-flight + Summary
# ============================================================
- name: "VPN Toggle — Post-flight et résumé"
  hosts: all
  gather_facts: false
  tasks:
    - name: "POST-FLIGHT: SSH toujours accessible"
      ansible.builtin.ping:

    - name: "POST-FLIGHT: État UFW"
      ansible.builtin.command:
        cmd: ufw status verbose
      changed_when: false
      register: _ufw_post

    - name: "POST-FLIGHT: Afficher UFW"
      ansible.builtin.debug:
        msg: "{{ _ufw_post.stdout_lines }}"

    - name: "POST-FLIGHT: Conteneurs Docker"
      ansible.builtin.command:
        cmd: docker ps --format "{{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}"
      changed_when: false
      register: _docker_post

    - name: "POST-FLIGHT: Afficher conteneurs"
      ansible.builtin.debug:
        msg: "{{ _docker_post.stdout_lines }}"

    - name: "Résumé du toggle VPN"
      ansible.builtin.debug:
        msg:
          - "══════════════════════════════════════════"
          - "  VPN TOGGLE TERMINÉ"
          - "══════════════════════════════════════════"
          - "  Mode        : {{ 'VPN-ONLY' if vpn_mode == 'on' else 'PUBLIC' }}"
          - "  UFW 80/443  : Ouvert à tous (toujours — Tailscale bootstrap)"
          - "  Caddy garde : {{ 'CIDR VPN 100.64.0.0/10 (403 sinon)' if vpn_mode == 'on' else 'Accès public' }}"
          - "  Headscale   : Public (toujours)"
          - "  Uptime K.   : Public (toujours)"
          - "  Dead man    : Annulé (toggle réussi)"
          - "══════════════════════════════════════════"
