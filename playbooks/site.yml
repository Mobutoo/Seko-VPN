---
# ============================================================
# Playbook principal : Déploiement VPN & Vault
# ============================================================
# Usage :
#   Déploiement complet (en root, port 22) :
#     ansible-playbook playbooks/site.yml
#
#   Déploiement d'un seul rôle (par tag) :
#     ansible-playbook playbooks/site.yml --tags headscale
#
#   Mode check (dry-run) :
#     ansible-playbook playbooks/site.yml --check --diff
#
# IMPORTANT : Ce playbook ne modifie PAS le port SSH ni la
#   connexion root. Une fois que tout fonctionne, lancer :
#     ansible-playbook playbooks/harden-ssh.yml
# ============================================================

- name: "Déploiement VPN & Vault sur {{ server_ip }}"
  hosts: all
  become: true
  gather_facts: true

  # Vérifications avant exécution
  pre_tasks:
    - name: Vérification de la distribution cible
      ansible.builtin.assert:
        that:
          - ansible_distribution == "Debian"
          - ansible_distribution_major_version | int >= 12
        fail_msg: >
          Ce playbook cible Debian 12+ (trouvé : {{ ansible_distribution }}
          {{ ansible_distribution_version }})

    - name: Vérification que les variables obligatoires sont définies
      ansible.builtin.assert:
        that:
          - system_user is defined and system_user | length > 0
          - system_user_ssh_pubkey is defined and system_user_ssh_pubkey | length > 0
          - domain_headscale is defined and domain_headscale | length > 0
          - domain_vaultwarden is defined and domain_vaultwarden | length > 0
          - domain_portainer is defined and domain_portainer | length > 0
          - acme_email is defined and acme_email | length > 0
          - vault_system_user_password is defined and vault_system_user_password != "CHANGER_MOI_mdp_sudo_fort"
          - vault_vaultwarden_admin_token is defined and vault_vaultwarden_admin_token != "CHANGER_MOI_token_admin_vaultwarden"
          - domain_zerobyte is defined and domain_zerobyte | length > 0
          - vault_telegram_bot_token is defined and vault_telegram_bot_token != "CHANGER_MOI_bot_token"
          - vault_telegram_chat_id is defined and vault_telegram_chat_id != "CHANGER_MOI_chat_id"
          - vault_zerobyte_app_secret is defined and vault_zerobyte_app_secret != "CHANGER_MOI_zerobyte_secret_hex64"
        fail_msg: >
          Des variables obligatoires ne sont pas définies ou contiennent
          encore les valeurs par défaut. Vérifiez vars.yml et vault.yml.

    - name: Affichage du résumé de déploiement
      ansible.builtin.debug:
        msg: |
          ╔══════════════════════════════════════════╗
          ║       DÉPLOIEMENT VPN & VAULT            ║
          ╠══════════════════════════════════════════╣
          ║ Utilisateur : {{ system_user }}
          ║ Headscale   : {{ domain_headscale }}
          ║ Headplane   : {{ domain_headplane }}
          ║ Vaultwarden : {{ domain_vaultwarden }}
          ║ Portainer   : {{ domain_portainer }}
          ║ Zerobyte    : {{ domain_zerobyte }}
          ║ Monit       : localhost:{{ monit_web_port }}
          ╚══════════════════════════════════════════╝

  roles:
    # 1. Configuration système de base, dépôts Debian, création utilisateur
    - role: common
      tags: [common, base]

    # 2. Sécurité serveur (firewall, fail2ban, sysctl) - SANS toucher à SSH
    - role: security
      tags: [security, firewall]

    # 3. Installation de Docker et Docker Compose
    - role: docker
      tags: [docker]

    # 4. Reverse proxy Caddy (SSL automatique)
    - role: caddy
      tags: [caddy, proxy]

    # 5. Serveur VPN Headscale
    - role: headscale
      tags: [headscale, vpn]

    # 5b. Interface web Headplane (UI pour Headscale)
    - role: headplane
      tags: [headplane, vpn, ui]

    # 6. Gestionnaire de mots de passe Vaultwarden
    - role: vaultwarden
      tags: [vaultwarden, vault]

    # 7. Interface de supervision Portainer
    - role: portainer
      tags: [portainer]

    # 8. Gestion des sauvegardes Zerobyte
    - role: zerobyte
      tags: [zerobyte, backup]

    # 9. Supervision et alerting Monit (en dernier : supervise tout)
    - role: monit
      tags: [monit, monitoring]

  # Actions post-déploiement
  post_tasks:
    # Caddy doit être rechargé APRÈS que tous les conteneurs sont up
    # sur le réseau proxy-net, sinon il ne peut pas résoudre les backends
    # déployés après lui (zerobyte, etc.) et ne demande pas leurs certificats.
    - name: Rechargement de Caddy (résolution de tous les backends)
      ansible.builtin.command: docker exec caddy caddy reload --config /etc/caddy/Caddyfile
      register: caddy_reload
      changed_when: caddy_reload.rc == 0
      failed_when: false
      tags: [caddy, proxy, always]

    - name: Vérification du rechargement Caddy
      ansible.builtin.debug:
        msg: "{{ 'Caddy rechargé — tous les certificats seront demandés' if caddy_reload.rc == 0 else 'ATTENTION : échec du reload Caddy — vérifier les logs (docker logs caddy)' }}"
      tags: [caddy, proxy, always]

    - name: Résumé post-déploiement
      ansible.builtin.debug:
        msg: |
          ╔══════════════════════════════════════════════╗
          ║       DÉPLOIEMENT TERMINÉ ✓                  ║
          ╠══════════════════════════════════════════════╣
          ║                                              ║
          ║ Services accessibles :                       ║
          ║  - https://{{ domain_headscale }}
          ║  - https://{{ domain_headplane }}/admin
          ║  - https://{{ domain_vaultwarden }}
          ║  - https://{{ domain_portainer }}
          ║  - https://{{ domain_zerobyte }}
          ║                                              ║
          ║ Supervision :                                ║
          ║  - Monit (localhost:{{ monit_web_port }})
          ║  - Alertes Telegram activées                 ║
          ║                                              ║
          ║ ⚠️  PROCHAINES ÉTAPES :                      ║
          ║                                              ║
          ║ 1. Vérifier que toutes les URLs fonctionnent ║
          ║ 2. Créer les comptes (VW, Portainer, ZB)     ║
          ║ 3. Configurer les sauvegardes dans Zerobyte  ║
          ║ 4. PUIS durcir SSH :                         ║
          ║    ansible-playbook playbooks/harden-ssh.yml  ║
          ║                                              ║
          ╚══════════════════════════════════════════════╝
