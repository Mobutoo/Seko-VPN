---
# ============================================================
# Playbook principal : DÃ©ploiement VPN & Vault
# ============================================================
# Usage :
#   DÃ©ploiement complet :
#     ansible-playbook playbooks/site.yml
#
#   DÃ©ploiement d'un seul rÃ´le (par tag) :
#     ansible-playbook playbooks/site.yml --tags headscale
#
#   Mode check (dry-run) :
#     ansible-playbook playbooks/site.yml --check --diff
# ============================================================

- name: "DÃ©ploiement VPN & Vault sur {{ server_ip }}"
  hosts: all
  become: true
  gather_facts: true

  # VÃ©rifications avant exÃ©cution
  pre_tasks:
    - name: VÃ©rification de la distribution cible
      ansible.builtin.assert:
        that:
          - ansible_distribution == "Debian"
          - ansible_distribution_major_version | int >= 12
        fail_msg: >
          Ce playbook cible Debian 12+ (trouvÃ© : {{ ansible_distribution }}
          {{ ansible_distribution_version }})

    - name: VÃ©rification que les variables obligatoires sont dÃ©finies
      ansible.builtin.assert:
        that:
          - system_user is defined and system_user | length > 0
          - system_user_ssh_pubkey is defined and system_user_ssh_pubkey | length > 0
          - domain_headscale is defined and domain_headscale | length > 0
          - domain_vaultwarden is defined and domain_vaultwarden | length > 0
          - domain_portainer is defined and domain_portainer | length > 0
          - acme_email is defined and acme_email | length > 0
          - vault_system_user_password is defined and vault_system_user_password != "CHANGER_MOI_mdp_sudo_fort"
          - vault_vaultwarden_admin_token is defined and vault_vaultwarden_admin_token != "CHANGER_MOI_token_admin_vaultwarden"
        fail_msg: >
          Des variables obligatoires ne sont pas dÃ©finies ou contiennent
          encore les valeurs par dÃ©faut. VÃ©rifiez vars.yml et vault.yml.

    - name: Affichage du rÃ©sumÃ© de dÃ©ploiement
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘       DÃ‰PLOIEMENT VPN & VAULT            â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ Utilisateur : {{ system_user }}
          â•‘ Headscale   : {{ domain_headscale }}
          â•‘ Vaultwarden : {{ domain_vaultwarden }}
          â•‘ Portainer   : {{ domain_portainer }}
          â•‘ Port SSH    : {{ ssh_custom_port }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  roles:
    # 1. Configuration systÃ¨me de base et crÃ©ation utilisateur
    - role: common
      tags: [common, base]

    # 2. Durcissement de la sÃ©curitÃ© (firewall, fail2ban, sysctl)
    - role: security
      tags: [security, firewall]

    # 3. Installation de Docker et Docker Compose
    - role: docker
      tags: [docker]

    # 4. Reverse proxy Caddy (SSL automatique)
    - role: caddy
      tags: [caddy, proxy]

    # 5. Serveur VPN Headscale
    - role: headscale
      tags: [headscale, vpn]

    # 6. Gestionnaire de mots de passe Vaultwarden
    - role: vaultwarden
      tags: [vaultwarden, vault]

    # 7. Interface de supervision Portainer
    - role: portainer
      tags: [portainer]

  # Actions post-dÃ©ploiement
  post_tasks:
    - name: RÃ©sumÃ© post-dÃ©ploiement
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘       DÃ‰PLOIEMENT TERMINÃ‰ âœ“              â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                          â•‘
          â•‘ Services accessibles :                   â•‘
          â•‘                                          â•‘
          â•‘ ğŸ” VPN Headscale :                      â•‘
          â•‘    https://{{ domain_headscale }}
          â•‘                                          â•‘
          â•‘ ğŸ—ï¸  Vaultwarden :                        â•‘
          â•‘    https://{{ domain_vaultwarden }}
          â•‘    Admin : https://{{ domain_vaultwarden }}/admin
          â•‘                                          â•‘
          â•‘ ğŸ“Š Portainer :                           â•‘
          â•‘    https://{{ domain_portainer }}
          â•‘                                          â•‘
          â•‘ âš ï¸  ACTIONS MANUELLES REQUISES :         â•‘
          â•‘ 1. CrÃ©er un user Headscale (voir doc)    â•‘
          â•‘ 2. CrÃ©er un compte Vaultwarden           â•‘
          â•‘ 3. CrÃ©er le mot de passe admin Portainer â•‘
          â•‘ 4. DÃ©sactiver les inscriptions VW        â•‘
          â•‘ 5. Mettre Ã  jour le port SSH dans        â•‘
          â•‘    l'inventaire ({{ ssh_custom_port }})   â•‘
          â•‘                                          â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
